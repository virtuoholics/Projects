
Notes:
======
I've used as reference the attached image to model all transit and tenant VPCs.

Distributing the code in module obviously means that either the transit segment or tenants could be created in any account or region. All you need to do is modify the terraform.tfvars file.

I've used single AZ in transit VPCs as well as whereever possible because of three reasons:
    - TGW-attachment only routes traffic for subnets local to its AZ.
    - Nat-GW cross zone traffic incurs cost.
    - There is no indication in the design for TGW attachments or NGWs being in multiple AZs.

I had to correct two flaws in the design:
    1. For NLB to use ALB as target-type "alb", both must be in the same AZ. Also, only NLB can have static IPs which could be used by ALB as targt-type "ip". Both conditions call for ALB to be put on network edge and (internal-type) NLB to be placed in tenant VPCs.
    2. Both ALB and NGW must have direct connectivity to the IGW to work. To achieve this, I had to use this traffic flow:
        - internet => ALB => firewall => TGW-attachment => TGW => tenant VPCs
        - tenant VPCs => TGW => TGW-attachment => firewall => NAT-GW => internet

ALB must have at least two subnets in different AZs to operate, so I had to create an additional (nat) subnet in transit VPCs.

There is no need for a special IGW route table (as suggested in the design). Any route table to which the IGW is attached is called "gateway route table". In our case, the route table for "nat" subnet (with ALB and NAT-GW) has IGW attached.

You'll get ALB dns-names of all the three ALBs at the end of deployment, which will be used by your clients to access servers (attached to NLB) in tenant VPCs.

You'll get and error message saying the TGW attachments are in "invalid state" but don't panic. The TGWs attach to the TGW just fine, and associate with and propagate their routes to the TGW route table just fine. It's a known Terraform bug which is being worked out.

Everything's been tested except the multi-account setup of course. But it should work just fine.